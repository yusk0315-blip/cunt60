<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å‡ºè²»ã‚¸ãƒ£ãƒƒã‚¸ã‚²ãƒ¼ãƒ ï½œ60ç§’ã§å®¶è¨ˆã‚’å®ˆã‚Œ</title>
  <meta name="description" content="60ç§’ã§æ¬¡ã€…ãã‚‹å‡ºè²»ã‚«ãƒ¼ãƒ‰ã‚’ã€æ‰•ã† / å‰Šã‚‹ã€ã§åˆ¤æ–­ï¼ã‚ãªãŸã®å®¶è¨ˆé˜²è¡›åŠ›ã‚’è©¦ãã†ã€‚" />
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#111b3a;
      --card:#0f1733cc;
      --card2:#121c3fcc;
      --stroke:#ffffff14;
      --text:#eaf0ff;
      --muted:#b9c3e6;
      --accent:#7aa8ff;
      --good:#76f2b1;
      --bad:#ff6b7a;
      --warn:#ffd46b;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(122,168,255,.28), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(118,242,177,.16), transparent 60%),
        radial-gradient(900px 650px at 50% 100%, rgba(255,107,122,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: calc(env(safe-area-inset-top) + 14px) 14px calc(env(safe-area-inset-bottom) + 22px);
    }
    .hero{
      position:relative;
      padding: 18px 18px 14px;
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(135deg, rgba(122,168,255,.18), rgba(255,255,255,.03));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 260px at 10% 0%, rgba(122,168,255,.28), transparent 60%),
        radial-gradient(500px 220px at 95% 30%, rgba(118,242,177,.18), transparent 60%);
      opacity:.9;
      pointer-events:none;
    }
    .hero > *{position:relative; z-index:1}
    .title{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
    }
    h1{margin:0;font-size:20px;letter-spacing:.3px;line-height:1.25}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(15,23,51,.55);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .tag b{color:var(--text); font-weight:900}
    .sub{margin:10px 0 0;color:var(--muted);font-size:13px;line-height:1.55}

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 880px){
      .grid{grid-template-columns: 1.05fr .95fr}
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(15,23,51,.72), rgba(15,23,51,.45));
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd .h{
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 14px;
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(18,28,63,.35);
      white-space:nowrap;
    }
    .card .bd{padding: 14px}

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .stat{
      padding: 10px 10px;
      border-radius: var(--radius2);
      border: 1px solid var(--stroke);
      background: rgba(18,28,63,.28);
      min-height: 66px;
    }
    .stat .k{font-size:11px;color:var(--muted);letter-spacing:.2px}
    .stat .v{margin-top:6px;font-size:18px;font-weight:1000;letter-spacing:.2px}
    .stat .v small{font-size:12px;color:var(--muted);font-weight:800}
    .bar{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bar>div{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(118,242,177,.85), rgba(122,168,255,.85));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .bar.bad>div{
      background: linear-gradient(90deg, rgba(255,107,122,.95), rgba(255,212,107,.65));
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .field{
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(18,28,63,.22);
      padding: 10px 10px;
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{color:var(--muted);font-size:11px;letter-spacing:.2px}
    .field input,.field select{
      width:100%;
      border:none;outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      font-weight:1000;
      font-family: var(--mono);
    }
    .field input::placeholder{color: rgba(185,195,230,.55)}

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toggle{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(18,28,63,.25);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .toggle input{accent-color: var(--accent)}

    .play{
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .stage{
      border-radius: calc(var(--radius) + 2px);
      border: 1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(122,168,255,.10), rgba(255,255,255,.03));
      padding: 14px;
      position:relative;
      overflow:hidden;
      min-height: 260px;
    }
    .stage:after{
      content:"";
      position:absolute;
      width: 520px; height: 520px;
      left: -260px; top: -260px;
      background: radial-gradient(circle at 30% 30%, rgba(122,168,255,.22), transparent 60%);
      pointer-events:none;
    }
    .stage > *{position:relative; z-index:1}
    .cardface{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(18,28,63,.55), rgba(15,23,51,.55));
      border: 1px solid var(--stroke);
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transform: translateY(0);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .cardface.bump{transform: translateY(-2px); box-shadow: 0 18px 38px rgba(0,0,0,.35);}
    .cardface.flash-good{filter: drop-shadow(0 0 10px rgba(118,242,177,.35));}
    .cardface.flash-bad{filter: drop-shadow(0 0 10px rgba(255,107,122,.35));}
    .ctype{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.20);
      font-size: 12px;
      color: var(--muted);
    }
    .amt{font-family:var(--mono);font-size:16px;font-weight:1000;letter-spacing:.3px}
    .question{font-size:16px;font-weight:1000;line-height:1.35;letter-spacing:.2px;margin:6px 0 8px}
    .hint{color:var(--muted);font-size:12px;line-height:1.55;margin:0}
    .buttons{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    button{
      -webkit-tap-highlight-color: transparent;
      border: none;
      border-radius: 16px;
      padding: 13px 12px;
      font-size: 14px;
      font-weight: 1000;
      letter-spacing:.2px;
      cursor:pointer;
      color: var(--text);
      transition: transform .08s ease, filter .15s ease, opacity .2s ease;
      box-shadow: 0 14px 26px rgba(0,0,0,.22);
      user-select:none;
    }
    button:active{transform: translateY(1px) scale(.99)}
    .btn-pay{background: linear-gradient(135deg, rgba(255,107,122,.95), rgba(255,212,107,.70));}
    .btn-cut{background: linear-gradient(135deg, rgba(118,242,177,.85), rgba(122,168,255,.85));}
    .btn-ghost{
      background: rgba(18,28,63,.25);
      border: 1px solid var(--stroke);
      box-shadow:none;
      font-weight:900;
    }
    .btn-main{
      background: linear-gradient(135deg, rgba(122,168,255,.85), rgba(118,242,177,.70));
    }

    .footer{margin-top: 12px;color: rgba(185,195,230,.78);font-size: 12px;line-height:1.55}
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom) + 14px);
      background: rgba(15,23,51,.92);
      border: 1px solid var(--stroke);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-size: 12px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 99;
      max-width: min(92vw, 520px);
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}
    .modal{
      position: fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 100;
    }
    .modal.show{display:flex}
    .panel{
      width: min(740px, 100%);
      border-radius: 22px;
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(15,23,51,.92), rgba(15,23,51,.76));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .ph{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--stroke);
    }
    .panel .ph h2{margin:0;font-size: 15px;letter-spacing:.2px}
    .panel .pb{padding: 14px}

    .result{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 720px){
      .result{grid-template-columns: 1.1fr .9fr}
    }
    .rbox{
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(18,28,63,.25);
      padding: 12px;
    }
    .score{
      font-size: 28px;
      font-weight: 1000;
      letter-spacing:.3px;
      margin: 6px 0 0;
      font-family: var(--mono);
    }
    .muted{color: var(--muted)}
    .list{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
      line-height:1.65;
      font-size: 13px;
    }
    .kbd{
      font-family: var(--mono);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.22);
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 12px;
      color: var(--text);
    }
    .danger{color: var(--bad); font-weight: 1000}
    .good{color: var(--good); font-weight: 1000}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(18,28,63,.18);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
  </style>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="å‡ºè²»ã‚¸ãƒ£ãƒƒã‚¸" />
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <div class="title">
        <div>
          <h1>å‡ºè²»ã‚¸ãƒ£ãƒƒã‚¸ã‚²ãƒ¼ãƒ ï½œ60ç§’ã§å®¶è¨ˆã‚’å®ˆã‚Œ</h1>
          <p class="sub">æ¬¡ã€…ãã‚‹å‡ºè²»ã‚«ãƒ¼ãƒ‰ã‚’ <b>ã€Œæ‰•ã† / å‰Šã‚‹ã€</b>ã§åˆ¤æ–­ã€‚<br>æ®‹é«˜ãŒã‚¼ãƒ­ã«ãªã‚‹å‰ã«ã€ã‚ãªãŸã®å®¶è¨ˆã‚’å®ˆã‚Šåˆ‡ã‚Œã€‚</p>
        </div>
        <div class="tag">â± <b>60ç§’</b> / ğŸ’¸ å‡ºè²»ã‚«ãƒ¼ãƒ‰ / ğŸ“± ã‚¹ãƒãƒ›å¯¾å¿œ</div>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <div class="hd">
          <div class="h">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          <div class="pill" id="bestPill">BEST: -</div>
        </div>
        <div class="bd">
          <div class="stats">
            <div class="stat">
              <div class="k">æ®‹ã‚Šæ™‚é–“</div>
              <div class="v"><span id="timeLeft">60</span><small> ç§’</small></div>
              <div class="bar" id="timeBar"><div style="width:100%"></div></div>
            </div>
            <div class="stat">
              <div class="k">æ®‹é«˜</div>
              <div class="v"><span id="balance">50,000</span><small> å††</small></div>
              <div class="bar" id="balBar"><div style="width:100%"></div></div>
            </div>
            <div class="stat">
              <div class="k">ã‚¹ã‚³ã‚¢</div>
              <div class="v"><span id="score">0</span><small> pt</small></div>
              <div class="bar" id="scoreBar"><div style="width:0%"></div></div>
            </div>
          </div>

          <div class="form" aria-label="è¨­å®š">
            <div class="field">
              <label for="startMoney">é–‹å§‹æ®‹é«˜ï¼ˆå††ï¼‰</label>
              <input id="startMoney" inputmode="numeric" pattern="[0-9]*" placeholder="50000" value="50000" />
            </div>
            <div class="field">
              <label for="difficulty">é›£æ˜“åº¦</label>
              <select id="difficulty">
                <option value="easy">ã‚„ã•ã—ã„</option>
                <option value="normal" selected>ãµã¤ã†</option>
                <option value="hard">ã‚€ãšã„</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="controls">
              <label class="toggle"><input id="soundOn" type="checkbox" checked> åŠ¹æœéŸ³</label>
              <label class="toggle"><input id="vibeOn" type="checkbox" checked> ãƒã‚¤ãƒ–</label>
            </div>
            <div class="controls">
              <span class="chip" id="seedChip">seed: -</span>
              <button class="btn-ghost" id="btnHow">éŠã³æ–¹</button>
            </div>
          </div>
          <p class="footer">â€» è©¦ä½œç‰ˆï¼ˆindex.html 1æšï¼‰ã§ã™ã€‚GitHub Pagesã«ãã®ã¾ã¾ç½®ã‘ã°å‹•ãã¾ã™ã€‚</p>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <div class="h">ğŸ´ ãƒ—ãƒ¬ã‚¤</div>
          <div class="pill" id="statePill">å¾…æ©Ÿä¸­</div>
        </div>
        <div class="play">
          <div class="stage">
            <div class="cardface" id="cardFace">
              <div class="ctype">
                <div class="badge" id="catBadge">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
                <div class="amt" id="amtText">Â¥0</div>
              </div>
              <div class="question" id="qText">ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ã­</div>
              <p class="hint" id="hintText">å‡ºè²»ã‚«ãƒ¼ãƒ‰ãŒå‡ºãŸã‚‰ã€Œæ‰•ã† / å‰Šã‚‹ã€ã§åˆ¤æ–­ã€‚å‰Šã‚‹ã¨å°†æ¥ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒã‚ã‚‹ã“ã¨ã‚‚ã€‚</p>

              <div class="buttons">
                <button class="btn-pay" id="btnPay" disabled>ğŸ’¸ æ‰•ã†</button>
                <button class="btn-cut" id="btnCut" disabled>âœ‚ï¸ å‰Šã‚‹</button>
              </div>
            </div>
          </div>

          <div class="row">
            <button class="btn-main" id="btnStart">â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button class="btn-ghost" id="btnReset">â†» ãƒªã‚»ãƒƒãƒˆ</button>
          </div>

          <div class="row">
            <div class="muted" style="font-size:12px">
              ã‚­ãƒ¼æ“ä½œï¼š<span class="kbd">â†</span> æ‰•ã† / <span class="kbd">â†’</span> å‰Šã‚‹ / <span class="kbd">Space</span> ã‚¹ã‚¿ãƒ¼ãƒˆ
            </div>
            <button class="btn-ghost" id="btnShare">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
          </div>

          <div class="row">
            <div class="muted" style="font-size:12px">â€» ã‚«ãƒ¼ãƒ‰ã¯ã‚ãªãŸãŒæŠ¼ã™ã¾ã§é€²ã¾ãªã„ï¼2æŠãŒé€Ÿã„ã»ã©ã‚¹ã‚³ã‚¢UPï¼ˆè¿·ã†ã»ã©ä¸åˆ©ï¼‰</div>
            <div class="muted" style="font-size:12px" id="logLine">-</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <!-- How to -->
  <div class="modal" id="modalHow">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="ph">
        <h2 id="modalTitle">éŠã³æ–¹</h2>
        <button class="btn-ghost" id="btnCloseHow">é–‰ã˜ã‚‹</button>
      </div>
      <div class="pb">
        <div class="rbox">
          <ul class="list">
            <li>åˆ¶é™æ™‚é–“ã¯ <b>60ç§’</b>ã€‚å‡ºè²»ã‚«ãƒ¼ãƒ‰ãŒæ¬¡ã€…ãã‚‹ã€‚</li>
            <li><b class="danger">æ‰•ã†</b>ï¼šæ®‹é«˜ãŒæ¸›ã‚‹ï¼ˆã§ã‚‚ã€Œå¿…è¦ãªæ”¯å‡ºã€ã¯æ‰•ã‚ãªã„ã¨å°†æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰ã€‚</li>
            <li><b class="good">å‰Šã‚‹</b>ï¼šæ®‹é«˜ã¯å®ˆã‚Œã‚‹ï¼ˆã§ã‚‚æº€è¶³åº¦ãƒ€ã‚¦ãƒ³ï¼å°†æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå‡ºã‚‹ã“ã¨ã‚‚ï¼‰ã€‚</li>
            <li>ã‚¹ã‚³ã‚¢ã¯ã€Œåˆ¤æ–­ã®ç²¾åº¦ã€ï¼‹ã€Œã‚¹ãƒ”ãƒ¼ãƒ‰ã€ã€‚<b>è¿·ã†ã»ã©ä¸åˆ©</b>ã€‚</li>
            <li>æœ€å¾Œã« <b>åçœTOP3</b> ã¨ã€ã–ã£ãã‚Šæœªæ¥ã‚³ãƒ¡ãƒ³ãƒˆãŒå‡ºã‚‹ã€‚</li>
          </ul>
        </div>
        <p class="footer">ãƒ’ãƒ³ãƒˆï¼šå›ºå®šè²»ï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒ»é€šä¿¡ãƒ»ä¿é™ºï¼‰ã‚’å‰Šã‚‹ã®ã¯å¼·ã„ã€‚å®‰å…¨ãƒ»å¥åº·ç³»ã¯å‰Šã‚Šã™ãæ³¨æ„ã€‚</p>
      </div>
    </div>
  </div>

  <!-- Result -->
  <div class="modal" id="modalResult">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
      <div class="ph">
        <h2 id="resultTitle">çµæœ</h2>
        <button class="btn-ghost" id="btnCloseResult">é–‰ã˜ã‚‹</button>
      </div>
      <div class="pb">
        <div class="result">
          <div class="rbox">
            <div class="muted">æœ€çµ‚ã‚¹ã‚³ã‚¢</div>
            <div class="score" id="finalScore">0</div>
            <div class="muted" style="margin-top:10px">æ®‹é«˜</div>
            <div class="score" style="font-size:20px" id="finalBal">Â¥0</div>
            <div class="muted" style="margin-top:10px">å°†æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸</div>
            <div class="score" style="font-size:20px" id="finalRisk">0</div>
            <p class="footer" id="finalComment">ã‚³ãƒ¡ãƒ³ãƒˆ</p>
          </div>

          <div class="rbox">
            <div class="muted" style="font-weight:1000">åçœãƒã‚¤ãƒ³ãƒˆ TOP3</div>
            <ol class="list" id="topMistakes"></ol>
            <div class="muted" style="margin-top:10px; font-weight:1000">ã‚ãªãŸã®å‚¾å‘</div>
            <ul class="list" id="tendency"></ul>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn-main" id="btnAgain">ã‚‚ã†ä¸€å›</button>
          <button class="btn-ghost" id="btnCopy2">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // -------------------------
  // Helpers
  // -------------------------
  const $ = (id) => document.getElementById(id);
  const clamp = (n,a,b) => Math.min(b, Math.max(a,n));
  const fmt = (n) => {
    try { return Number(n).toLocaleString('ja-JP'); }
    catch { return String(n); }
  };

  function toast(msg){
    const t = $('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(toast._tm);
    toast._tm = setTimeout(() => t.classList.remove('show'), 1600);
  }

  // WebAudio mini beep
  let audioCtx = null;
  function beep(freq=440, dur=0.08, type='sine', gain=0.05){
    if(!$('soundOn').checked) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0.0001, t0);
      g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0);
      o.stop(t0 + dur + 0.02);
    }catch(e){}
  }
  function vibe(ms=18){
    if(!$('vibeOn').checked) return;
    try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){}
  }

  // Deterministic RNG (mulberry32)
  function mulberry32(seed){
    return function(){
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
  }
  function hashSeed(str){
    let h = 2166136261 >>> 0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  // -------------------------
  // Cards
  // payGood: 0..1 (higher means "æ‰•ã†"ãŒæ­£è§£å¯„ã‚Š)
  // riskPay / riskCut: 0..1 chance of future damage on that choice
  // impact: 1..5 (å¿ƒç†çš„/ç”Ÿæ´»ã¸ã®å½±éŸ¿åº¦) â€” å‰Šã‚‹ã¨æº€è¶³åº¦ãƒšãƒŠã«ä½¿ã†
  // -------------------------
  const CARDS = [
    {cat:"å›ºå®šè²»", title:"ä½¿ã£ã¦ãªã„ã‚µãƒ–ã‚¹ã‚¯ãŒ3ã¤æ®‹ã£ã¦ãŸ", amt:980,  payGood:.15, riskPay:.02, riskCut:.01, impact:1, note:"å›ºå®šè²»ã¯å‰Šã‚ŒãŸã‚‰å‹ã¡ã€‚"},
    {cat:"å›ºå®šè²»", title:"é€šä¿¡è²»ãŒé«˜ã„ã¾ã¾ï¼ˆãƒ—ãƒ©ãƒ³æœªå¤‰æ›´ï¼‰",   amt:2500, payGood:.10, riskPay:.03, riskCut:.02, impact:2, note:"è¦‹ç›´ã—ã§ä¸€æ°—ã«ä¸‹ãŒã‚‹ã€‚"},
    {cat:"å›ºå®šè²»", title:"ä¿é™ºã®è¦‹ç›´ã—ã‚’å…ˆå»¶ã°ã—",             amt:3500, payGood:.08, riskPay:.05, riskCut:.02, impact:2, note:"å‰Šã‚Œã‚‹ã¨å¤§ãã„ã€‚"},
    {cat:"å®¶æ—",   title:"å­ã©ã‚‚ã®ç¿’ã„äº‹ã‚’è¿½åŠ ã—ãŸã„ã¨è¨€ã‚ã‚ŒãŸ", amt:6000, payGood:.55, riskPay:.03, riskCut:.22, impact:4, note:"æº€è¶³åº¦ã«ç›´æ’ƒã€‚"},
    {cat:"é£Ÿè²»",   title:"ã‚³ãƒ³ãƒ“ãƒ‹ã§ã¤ã„è²·ã„è¶³ã—",               amt:720,  payGood:.10, riskPay:.02, riskCut:.01, impact:1, note:"ãƒãƒªãƒ„ãƒ¢æ ã€‚"},
    {cat:"é£Ÿè²»",   title:"å¤–é£Ÿï¼ˆãªã‚“ã¨ãªãï¼‰",                   amt:2400, payGood:.18, riskPay:.02, riskCut:.02, impact:2, note:"é »åº¦ãŒå¢—ãˆã‚‹ã¨å±é™ºã€‚"},
    {cat:"é£Ÿè²»",   title:"å‹é”ã¨é£²ã¿ä¼šã®èª˜ã„",                   amt:4500, payGood:.42, riskPay:.03, riskCut:.12, impact:3, note:"äººé–“é–¢ä¿‚ã‚‚å¤§äº‹ã€‚"},
    {cat:"è»Š",     title:"ã‚¬ã‚½ãƒªãƒ³é«˜é¨°ã§è¿½åŠ å‡ºè²»",               amt:3200, payGood:.35, riskPay:.02, riskCut:.05, impact:2, note:"ç§»å‹•å¤šã„ã¨ç—›ã„ã€‚"},
    {cat:"è»Š",     title:"ã‚¿ã‚¤ãƒ¤äº¤æ›ï¼ˆæƒ³å®šå¤–ï¼‰",                 amt:28000,payGood:.80, riskPay:.01, riskCut:.35, impact:5, note:"å®‰å…¨ç³»ã¯å‰Šã‚Šã™ãæ³¨æ„ã€‚"},
    {cat:"è»Š",     title:"æ´—è»Šãƒ»ã‚³ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®èª˜æƒ‘",             amt:3900, payGood:.20, riskPay:.02, riskCut:.01, impact:2, note:"æº€è¶³åº¦ã¯ä¸ŠãŒã‚‹ã€‚"},
    {cat:"ä½ã¾ã„", title:"å®¶é›»ãŒå£Šã‚ŒãŸï¼ˆç·Šæ€¥ï¼‰",                 amt:18000,payGood:.75, riskPay:.01, riskCut:.30, impact:5, note:"ç”Ÿæ´»ã‚¤ãƒ³ãƒ•ãƒ©ã€‚"},
    {cat:"ä½ã¾ã„", title:"å®¶è³ƒæ›´æ–°ã§ä¸ŠãŒã£ãŸ",                   amt:2000, payGood:.45, riskPay:.03, riskCut:.12, impact:3, note:"äº¤æ¸‰/å¼•è¶Šã—æ¤œè¨ã€‚"},
    {cat:"å¥åº·",   title:"æ­¯åŒ»è€…ã®æ¤œè¨ºï¼ˆåŠå¹´ã¶ã‚Šï¼‰",             amt:3500, payGood:.70, riskPay:.01, riskCut:.35, impact:4, note:"å…ˆå»¶ã°ã—ãŒé«˜ãã¤ãã€‚"},
    {cat:"å¥åº·",   title:"ã‚¸ãƒ ä¼šè²»ï¼ˆä»Šæœˆã»ã¼è¡Œã‘ã¦ãªã„ï¼‰",       amt:7980, payGood:.22, riskPay:.03, riskCut:.03, impact:2, note:"ä½¿ã‚ãªã„ãªã‚‰æ­¢ã‚ã‚‹ã€‚"},
    {cat:"è¶£å‘³",   title:"ã‚»ãƒ¼ãƒ«ã§æ¬²ã—ã„ç‰©ã‚’ç™ºè¦‹",               amt:6800, payGood:.18, riskPay:.02, riskCut:.01, impact:2, note:"è¡å‹•è²·ã„æ³¨æ„ã€‚"},
    {cat:"è¶£å‘³",   title:"æ¨ã—æ´»ã®ã‚°ãƒƒã‚ºãŒå‡ºãŸ",                 amt:5200, payGood:.35, riskPay:.02, riskCut:.06, impact:3, note:"å¹¸ç¦åº¦ã¯é«˜ã„ã€‚"},
    {cat:"æ•™è‚²",   title:"è³‡æ ¼ã®å‚è€ƒæ›¸ï¼ˆå°†æ¥ã«åŠ¹ãï¼‰",           amt:3800, payGood:.55, riskPay:.02, riskCut:.10, impact:3, note:"æŠ•è³‡ã«ãªã‚‹ã€‚"},
    {cat:"æ•™è‚²",   title:"å­ã©ã‚‚ã®çµµæœ¬ã‚’è¿½åŠ ã§è²·ã†",             amt:1800, payGood:.55, riskPay:.01, riskCut:.08, impact:3, note:"å°ã•ãã¦å¤§ãã„ã€‚"},
    {cat:"äº¤éš›",   title:"èª•ç”Ÿæ—¥ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ",                     amt:5000, payGood:.65, riskPay:.02, riskCut:.18, impact:4, note:"é–¢ä¿‚ã¯è³‡ç”£ã€‚"},
    {cat:"äº¤éš›",   title:"å† å©šè‘¬ç¥­ã®å‡ºè²»",                       amt:12000,payGood:.70, riskPay:.01, riskCut:.25, impact:5, note:"å‰Šã‚‹ã¨å¾ŒãŒæ€–ã„ã€‚"},
    {cat:"å›ºå®šè²»", title:"è¬ã®ã‚µãƒ–ã‚¹ã‚¯å¼•ãè½ã¨ã—ãŒç™ºè¦š",         amt:1480, payGood:.10, riskPay:.02, riskCut:.01, impact:1, note:"ã¾ãšè§£ç´„ã€‚"},
    {cat:"ä½ã¾ã„", title:"æ°´é“å…‰ç†±è²»ãŒé«˜ããªã£ãŸ",               amt:2600, payGood:.35, riskPay:.02, riskCut:.05, impact:2, note:"ç¯€é›»ãƒ»å¥‘ç´„è¦‹ç›´ã—ã€‚"},
    {cat:"è»Š",     title:"é§è»Šå ´ä»£ãŒä¸ŠãŒã£ãŸ",                   amt:1500, payGood:.40, riskPay:.02, riskCut:.08, impact:2, note:"æ¢ã—ç›´ã™ã¨å¼·ã„ã€‚"},
    {cat:"å¥åº·",   title:"ç¡çœ ã®ãŸã‚ã®æ•ï¼ˆã¡ã‚‡ã„é«˜ã„ï¼‰",         amt:9800, payGood:.40, riskPay:.02, riskCut:.06, impact:3, note:"å¥åº·æŠ•è³‡ã¯å›åã§ãã‚‹ã€‚"},
    {cat:"é£Ÿè²»",   title:"ã¾ã¨ã‚è²·ã„ï¼ˆä»Šæœˆã¯å®‰ã„ï¼‰",             amt:4200, payGood:.45, riskPay:.02, riskCut:.04, impact:2, note:"è¨ˆç”»çš„ãªã‚‰ã‚¢ãƒªã€‚"},
    {cat:"è¶£å‘³",   title:"ã‚«ãƒ•ã‚§ã§ä½œæ¥­ï¼ˆæ°—åˆ†è»¢æ›ï¼‰",             amt:980,  payGood:.28, riskPay:.01, riskCut:.01, impact:2, note:"ãŸã¾ã«å¿…è¦ã€‚"},
    {cat:"å›ºå®šè²»", title:"ä½¿ã£ã¦ãªã„ä¿ç®¡ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆå¹´æ‰•ã„ï¼‰",     amt:9900, payGood:.12, riskPay:.03, riskCut:.02, impact:1, note:"è§£ç´„ã§å³å‹ã¡ã€‚"},
    {cat:"æ•™è‚²",   title:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è¬›åº§ï¼ˆæœªæ¥ã«åŠ¹ãï¼‰",         amt:12000,payGood:.60, riskPay:.02, riskCut:.14, impact:4, note:"ç¶™ç¶šã§ãã‚‹ãªã‚‰å¼·ã„ã€‚"},
    {cat:"ä½ã¾ã„", title:"å®¶å…·ã‚’è²·ã„æ›¿ãˆãŸã„ï¼ˆã¾ã ä½¿ãˆã‚‹ï¼‰",     amt:16000,payGood:.25, riskPay:.02, riskCut:.03, impact:2, note:"å‹¢ã„è²·ã„æ³¨æ„ã€‚"},
    {cat:"äº¤éš›",   title:"è¦ªã¸ã®ä»•é€ã‚Šãƒ»æ´åŠ©",                   amt:8000, payGood:.62, riskPay:.02, riskCut:.22, impact:5, note:"ãƒãƒ©ãƒ³ã‚¹å¤§äº‹ã€‚"},
    {cat:"è»Š",     title:"è‡ªå‹•è»Šä¿é™ºã®æ›´æ–°ï¼ˆå€¤ä¸Šã’ï¼‰",           amt:3500, payGood:.55, riskPay:.02, riskCut:.20, impact:4, note:"è£œå„Ÿã¯è½ã¨ã—ã™ãæ³¨æ„ã€‚"},
    {cat:"å¥åº·",   title:"å¥åº·è¨ºæ–­ï¼ˆä¼šç¤¾ã®è£œåŠ©ã‚ã‚Šï¼‰",           amt:2000, payGood:.75, riskPay:.01, riskCut:.40, impact:5, note:"å…ˆé€ã‚ŠãŒé«˜ãã¤ãã€‚"},
    {cat:"é£Ÿè²»",   title:"ãƒ‡ãƒªãƒãƒªãƒ¼ï¼ˆãƒ©ã‚¯ã—ãŸã„ï¼‰",             amt:2200, payGood:.22, riskPay:.02, riskCut:.02, impact:2, note:"é »åº¦ã§æ­»ã¬ã€‚"},
    {cat:"å›ºå®šè²»", title:"ã‚¯ãƒ¬ã‚«å¹´ä¼šè²»ãŒç™ºç”Ÿ",                   amt:11000,payGood:.30, riskPay:.03, riskCut:.08, impact:2, note:"ç‰¹å…¸ä½¿ã£ã¦ã‚‹ï¼Ÿ"},
    {cat:"è¶£å‘³",   title:"ã‚¬ã‚¸ã‚§ãƒƒãƒˆæ–°ä½œï¼ˆæ¬²ã—ã„ï¼‰",             amt:24000,payGood:.25, riskPay:.03, riskCut:.04, impact:3, note:"æº€è¶³åº¦ã¯é«˜ã„ãŒé«˜é¡ã€‚"},
    {cat:"æ•™è‚²",   title:"å­ã©ã‚‚ã®ã‚¤ãƒ™ãƒ³ãƒˆå†™çœŸè³¼å…¥",             amt:3500, payGood:.55, riskPay:.02, riskCut:.12, impact:4, note:"æ€ã„å‡ºã¯æˆ»ã‚‰ãªã„ã€‚"},
    {cat:"ä½ã¾ã„", title:"ä¿®ç†ï¼ˆå°ã•ãªä¸å…·åˆï¼‰ã‚’æ”¾ç½®ã—ã¦ãŸ",     amt:6500, payGood:.70, riskPay:.01, riskCut:.30, impact:4, note:"æ”¾ç½®ãŒé«˜ãã¤ãã€‚"},
// --- è¿½åŠ ã‚«ãƒ¼ãƒ‰ï¼ˆv4ï¼‰ ---
    {cat:"å›ºå®šè²»", title:"ä½¿ã£ã¦ãªã„ã‚¢ãƒ—ãƒªèª²é‡‘ãŒæ¯æœˆç¶šã„ã¦ãŸ", amt:1280, payGood:0.10, riskPay:0.02, riskCut:0.01, impact:1, note:"è§£ç´„ã™ã‚Œã°å³å‹ã¡ã€‚"},
    {cat:"å›ºå®šè²»", title:"ã‚µãƒ–ã‚¹ã‚¯ã®ç„¡æ–™æœŸé–“ãŒçµ‚ã‚ã‚‹é€šçŸ¥", amt:1480, payGood:0.08, riskPay:0.02, riskCut:0.01, impact:1, note:"ç¶™ç¶šã™ã‚‹ä¾¡å€¤ã‚ã‚‹ï¼Ÿ"},
    {cat:"å›ºå®šè²»", title:"ãƒãƒƒãƒˆå›ç·šãŒå‰²é«˜ãƒ—ãƒ©ãƒ³ã®ã¾ã¾", amt:1800, payGood:0.12, riskPay:0.03, riskCut:0.02, impact:2, note:"ä¹—ã‚Šæ›ãˆã§ä¸€æ°—ã«ä¸‹ãŒã‚‹ã€‚"},
    {cat:"é‡‘è", title:"ãƒªãƒœæ‰•ã„ã®æ®‹é«˜ãŒå¢—ãˆã¦ãŸ", amt:9000, payGood:0.75, riskPay:0.01, riskCut:0.45, impact:5, note:"å„ªå…ˆåº¦MAXã€‚æ”¾ç½®ã¯åœ°ç„ã€‚"},
    {cat:"é‡‘è", title:"ã‚«ãƒ¼ãƒ‰ã®åˆ†å‰²æ‰‹æ•°æ–™ãŒç™ºç”Ÿ", amt:2200, payGood:0.65, riskPay:0.01, riskCut:0.35, impact:4, note:"æ—©ã‚ã«è¿”ã™ã¨ãƒ©ã‚¯ã€‚"},
    {cat:"é‡‘è", title:"æŠ•è³‡ã®ç©ç«‹ã‚’1ãƒ¶æœˆæ­¢ã‚ã‚‹èª˜æƒ‘", amt:30000, payGood:0.52, riskPay:0.02, riskCut:0.10, impact:3, note:"ç²¾ç¥çš„ãªå®‰å®šã‚‚å¤§äº‹ã€‚"},
    {cat:"å›ºå®šè²»", title:"å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªã®æœ‰æ–™ãƒ—ãƒ©ãƒ³æ›´æ–°", amt:480, payGood:0.28, riskPay:0.01, riskCut:0.01, impact:1, note:"ä½¿ã£ã¦ã‚‹ãªã‚‰OKã€‚"},
    {cat:"å›ºå®šè²»", title:"å‹•ç”»é…ä¿¡ã‚µãƒ¼ãƒ“ã‚¹2ã¤åŒæ™‚å¥‘ç´„", amt:1980, payGood:0.12, riskPay:0.02, riskCut:0.01, impact:1, note:"ã©ã£ã¡ã‚‚è¦‹ã¦ã‚‹ï¼Ÿ"},
    {cat:"é‡‘è", title:"ãµã‚‹ã•ã¨ç´ç¨ã€ã‚„ã‚‹ã‹è¿·ã†", amt:10000, payGood:0.55, riskPay:0.02, riskCut:0.06, impact:3, note:"æ‰‹é–“ã¨ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒãƒ©ãƒ³ã‚¹ã€‚"},
    {cat:"é‡‘è", title:"ç¢ºå®šç”³å‘Šã®ãŸã‚ã«ä¼šè¨ˆã‚½ãƒ•ãƒˆå°å…¥", amt:980, payGood:0.55, riskPay:0.01, riskCut:0.05, impact:2, note:"å‰¯æ¥­ã™ã‚‹ãªã‚‰æ™‚çŸ­æŠ•è³‡ã€‚"},
    {cat:"é£Ÿè²»", title:"ãŠè“å­ã‚’ã¾ã¨ã‚è²·ã„ï¼ˆã¤ã„ï¼‰", amt:1200, payGood:0.10, riskPay:0.02, riskCut:0.01, impact:1, note:"æ°—ã¥ã„ãŸã‚‰å¢—ãˆã‚‹ã‚„ã¤ã€‚"},
    {cat:"é£Ÿè²»", title:"ç‰›ä¸¼ãƒã‚§ãƒ¼ãƒ³ã§å¤œé£Ÿ", amt:650, payGood:0.18, riskPay:0.01, riskCut:0.01, impact:1, note:"å›æ•°ãŒå¢—ãˆã‚‹ã¨å±é™ºã€‚"},
    {cat:"é£Ÿè²»", title:"ã‚¹ãƒ¼ãƒ‘ãƒ¼ã®åŠé¡æƒ£èœï¼ˆãƒ©ãƒƒã‚­ãƒ¼ï¼‰", amt:980, payGood:0.35, riskPay:0.01, riskCut:0.01, impact:1, note:"ç¯€ç´„å¯„ã‚Šãªã‚‰ã‚¢ãƒªã€‚"},
    {cat:"é£Ÿè²»", title:"å­ã©ã‚‚ã®ãŠè“å­ã‚³ãƒ¼ãƒŠãƒ¼ã§ã­ã ã‚‰ã‚ŒãŸ", amt:450, payGood:0.45, riskPay:0.01, riskCut:0.06, impact:3, note:"ãŸã¾ã«OKã€ç¿’æ…£åŒ–æ³¨æ„ã€‚"},
    {cat:"é£Ÿè²»", title:"å‹é”ã®ãŠã™ã™ã‚åº—ã«è¡Œã", amt:3500, payGood:0.48, riskPay:0.02, riskCut:0.10, impact:3, note:"æº€è¶³åº¦ã¯é«˜ã‚ã€‚"},
    {cat:"ä½ã¾ã„", title:"ã‚¨ã‚¢ã‚³ãƒ³æ¸…æƒï¼ˆæ¥­è€…ï¼‰", amt:12000, payGood:0.62, riskPay:0.01, riskCut:0.18, impact:4, note:"æ”¾ç½®ã™ã‚‹ã¨é›»æ°—ä»£UPã€‚"},
    {cat:"ä½ã¾ã„", title:"ã‚«ãƒ¼ãƒ†ãƒ³ã‚’æ›¿ãˆãŸã„ï¼ˆã¾ã ä½¿ãˆã‚‹ï¼‰", amt:9000, payGood:0.22, riskPay:0.02, riskCut:0.02, impact:2, note:"å‹¢ã„è²·ã„æ³¨æ„ã€‚"},
    {cat:"ä½ã¾ã„", title:"æ°´æ¼ã‚Œã®æ°—é…â€¦ä¿®ç†ä¾é ¼", amt:15000, payGood:0.78, riskPay:0.01, riskCut:0.45, impact:5, note:"æ”¾ç½®ã§å€ã«ãªã‚‹ã€‚"},
    {cat:"ä½ã¾ã„", title:"åç´ã‚°ãƒƒã‚ºã‚’è²·ã„è¶³ã™", amt:2500, payGood:0.28, riskPay:0.01, riskCut:0.01, impact:2, note:"ã¾ãšæ–­æ¨é›¢ãŒå¼·ã„ã€‚"},
    {cat:"ä½ã¾ã„", title:"å®³è™«å¯¾ç­–ã‚°ãƒƒã‚º", amt:1800, payGood:0.55, riskPay:0.01, riskCut:0.10, impact:3, note:"ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›ã€‚"},
    {cat:"ä½ã¾ã„", title:"å®¶å…·ã®çµ„ã¿ç«‹ã¦ä»£è¡Œ", amt:5000, payGood:0.30, riskPay:0.01, riskCut:0.02, impact:2, note:"æ™‚é–“ã‚’è²·ã†åˆ¤æ–­ã€‚"},
    {cat:"è»Š", title:"ã‚ªã‚¤ãƒ«äº¤æ›ã®æ™‚æœŸãŒæ¥ãŸ", amt:6500, payGood:0.80, riskPay:0.01, riskCut:0.40, impact:5, note:"å…ˆå»¶ã°ã—ã¯é«˜ãã¤ãã€‚"},
    {cat:"è»Š", title:"ãƒ‰ãƒ©ãƒ¬ã‚³ãŒæ•…éšœã—ã¦è²·ã„æ›¿ãˆ", amt:22000, payGood:0.70, riskPay:0.01, riskCut:0.30, impact:4, note:"å®‰å…¨ã¯å®ˆã‚‹ã€‚"},
    {cat:"è»Š", title:"é«˜é€Ÿä»£ã‚’ã‚±ãƒã£ã¦ä¸‹é“ã§è¡Œãï¼Ÿ", amt:1800, payGood:0.32, riskPay:0.01, riskCut:0.02, impact:2, note:"æ™‚é–“ã¨ãŠé‡‘ã®äº¤æ›ã€‚"},
    {cat:"è»Š", title:"ETCå‰²å¼•ã®ãŸã‚ã«ã‚«ãƒ¼ãƒ‰æ›´æ–°", amt:1100, payGood:0.45, riskPay:0.01, riskCut:0.05, impact:2, note:"æ‰‹é–“ã¯å°‘ãªã‚ã€‚"},
    {cat:"è»Š", title:"é§è»Šå ´ã§å°ã‚­ã‚ºâ€¦ä¿®ç†ã™ã‚‹ï¼Ÿ", amt:30000, payGood:0.35, riskPay:0.02, riskCut:0.03, impact:3, note:"æ°—ã«ãªã‚‹ãªã‚‰æ—©ã‚ã€‚"},
    {cat:"å¥åº·", title:"é¢¨é‚ªæ°—å‘³â€¦ç—…é™¢è¡Œãï¼Ÿ", amt:2500, payGood:0.62, riskPay:0.01, riskCut:0.22, impact:4, note:"æ‚ªåŒ–ã™ã‚‹ã¨é•·å¼•ãã€‚"},
    {cat:"å¥åº·", title:"æ•´ä½“ãƒ»ãƒãƒƒã‚µãƒ¼ã‚¸ï¼ˆè‚©ã“ã‚Šï¼‰", amt:6000, payGood:0.38, riskPay:0.02, riskCut:0.03, impact:3, note:"ç¶™ç¶šã™ã‚‹ã¨å›ºå®šè²»åŒ–ã€‚"},
    {cat:"å¥åº·", title:"å¸‚è²©è–¬ã§æ¸ˆã¾ã›ã‚‹ã‹è¿·ã†", amt:1500, payGood:0.45, riskPay:0.01, riskCut:0.10, impact:3, note:"é‡ã„ãªã‚‰ç—…é™¢ã€‚"},
    {cat:"å¥åº·", title:"ãƒ¡ã‚¬ãƒã®åº¦ãŒåˆã‚ãªã„", amt:18000, payGood:0.58, riskPay:0.01, riskCut:0.14, impact:4, note:"ä»•äº‹åŠ¹ç‡ã«ã‚‚å½±éŸ¿ã€‚"},
    {cat:"å¥åº·", title:"å¥åº·çš„ãªé£Ÿæã«åˆ‡ã‚Šæ›¿ãˆã‚‹", amt:2800, payGood:0.50, riskPay:0.01, riskCut:0.06, impact:3, note:"ç„¡ç†ãªãç¶šãç¯„å›²ã§ã€‚"},
    {cat:"å­è‚²ã¦", title:"å®¶æ—ã§ãŠå‡ºã‹ã‘ï¼ˆæ€ã„å‡ºï¼‰", amt:8000, payGood:0.62, riskPay:0.02, riskCut:0.18, impact:5, note:"æ€ã„å‡ºã¯æˆ»ã‚‰ãªã„ã€‚"},
    {cat:"å­è‚²ã¦", title:"å­ã©ã‚‚ã®é´ãŒå°ã•ããªã£ãŸ", amt:3500, payGood:0.85, riskPay:0.01, riskCut:0.45, impact:5, note:"å¿…è¦æ”¯å‡ºã€‚"},
    {cat:"å­è‚²ã¦", title:"ä¿è‚²åœ’ã®ç”¨å“è¿½åŠ è³¼å…¥", amt:2200, payGood:0.78, riskPay:0.01, riskCut:0.35, impact:4, note:"å¿…è¦ãªã‚„ã¤ã€‚"},
    {cat:"æ•™è‚²", title:"è‹±èªã‚¢ãƒ—ãƒªã‚’å§‹ã‚ã‚‹ï¼ˆ1ãƒ¶æœˆï¼‰", amt:1200, payGood:0.48, riskPay:0.01, riskCut:0.04, impact:2, note:"ç¶šããªã‚‰æŠ•è³‡ã€‚"},
    {cat:"æ•™è‚²", title:"æœ¬ã‚’1å†Šè²·ã†ï¼ˆå­¦ã³ï¼‰", amt:1650, payGood:0.58, riskPay:0.01, riskCut:0.05, impact:2, note:"å­¦ã³ã¯å›åã§ãã‚‹ã€‚"},
    {cat:"æ•™è‚²", title:"ã‚»ãƒŸãƒŠãƒ¼å‚åŠ ï¼ˆå°†æ¥ã«åŠ¹ãï¼‰", amt:5000, payGood:0.55, riskPay:0.02, riskCut:0.10, impact:3, note:"è¡Œå‹•ã«ã¤ãªãŒã‚‹ãªã‚‰OKã€‚"},
    {cat:"å­è‚²ã¦", title:"å­ã©ã‚‚ãŒã€ä¸€ç·’ã«éŠã¼ã€ã¨è¨€ã£ã¦ããŸï¼ˆæ™‚é–“ã®å‡ºè²»ï¼‰", amt:0, payGood:0.75, riskPay:0.00, riskCut:0.25, impact:5, note:"ãŠé‡‘ã˜ã‚ƒãªãæ™‚é–“ã€‚å„ªå…ˆåº¦é«˜ã€‚"},
    {cat:"å­è‚²ã¦", title:"å†™çœŸã‚¹ã‚¿ã‚¸ã‚ªã§è¨˜å¿µæ’®å½±", amt:20000, payGood:0.55, riskPay:0.02, riskCut:0.18, impact:5, note:"æ€ã„å‡ºç³»ã¯æº€è¶³åº¦å¤§ã€‚"},
    {cat:"äº¤éš›", title:"åŒåƒšã®é€åˆ¥ä¼š", amt:5000, payGood:0.58, riskPay:0.02, riskCut:0.16, impact:4, note:"é–¢ä¿‚ã¯è³‡ç”£ã€‚"},
    {cat:"äº¤éš›", title:"é£²ã¿ä¼š2ä»¶ç›®ã«è¡Œãï¼Ÿ", amt:3000, payGood:0.18, riskPay:0.02, riskCut:0.02, impact:2, note:"ä»Šæ—¥ã ã‘ãªã‚‰â€¦ãŒç©ã¿ä¸ŠãŒã‚‹ã€‚"},
    {cat:"äº¤éš›", title:"è¦ªå‹ã®çµå©šå¼ï¼ˆäºŒæ¬¡ä¼šï¼‰", amt:8000, payGood:0.60, riskPay:0.02, riskCut:0.20, impact:5, note:"å¾Œæ‚”ã—ã‚„ã™ã„æ ã€‚"},
    {cat:"è¶£å‘³", title:"ã‚²ãƒ¼ãƒ èª²é‡‘ï¼ˆã¤ã„ï¼‰", amt:2000, payGood:0.12, riskPay:0.02, riskCut:0.01, impact:1, note:"ãƒãƒªãƒ„ãƒ¢æ³¨æ„ã€‚"},
    {cat:"è¶£å‘³", title:"è¶£å‘³ã®é“å…·ã‚’ãƒ¡ãƒ³ãƒ†ã™ã‚‹", amt:3500, payGood:0.45, riskPay:0.01, riskCut:0.06, impact:2, note:"é•·ãä½¿ã†ãªã‚‰ã‚¢ãƒªã€‚"},
    {cat:"è¶£å‘³", title:"æ˜ ç”»é¤¨ã«è¡Œã", amt:1900, payGood:0.35, riskPay:0.01, riskCut:0.03, impact:2, note:"æº€è¶³åº¦ã¯é«˜ã„ã€‚"},
    {cat:"è¶£å‘³", title:"å®¶ã§ã®å¨¯æ¥½ï¼ˆãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ è³¼å…¥ï¼‰", amt:4800, payGood:0.40, riskPay:0.01, riskCut:0.04, impact:3, note:"å®¶æ—ã§ä½¿ã†ãªã‚‰å¼·ã„ã€‚"},
    {cat:"å‰¯æ¥­", title:"ã›ã©ã‚Šã®ä»•å…¥ã‚Œï¼ˆåˆ©ç›Šè¦‹è¾¼ã¿ã‚ã‚Šï¼‰", amt:15000, payGood:0.60, riskPay:0.02, riskCut:0.14, impact:3, note:"å›è»¢ã¨åœ¨åº«ç®¡ç†ãŒå‘½ã€‚"},
    {cat:"å‰¯æ¥­", title:"ä»•å…¥ã‚ŒãŒå®‰ã„â€¦ã§ã‚‚å£²ã‚Œã‚‹ã‹ä¸å®‰", amt:9000, payGood:0.45, riskPay:0.03, riskCut:0.06, impact:3, note:"ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ãªã‚‰GOã€‚"},
    {cat:"å‰¯æ¥­", title:"æ¢±åŒ…æã‚’ã¾ã¨ã‚è²·ã„", amt:2500, payGood:0.55, riskPay:0.01, riskCut:0.05, impact:2, note:"ä½œæ¥­åŠ¹ç‡UPã€‚"},
    {cat:"ä»•äº‹", title:"å–¶æ¥­ãƒ„ãƒ¼ãƒ«ï¼ˆååˆºãƒ»è³‡æ–™ï¼‰ã‚’æ–°èª¿", amt:3500, payGood:0.48, riskPay:0.01, riskCut:0.06, impact:2, note:"æˆæœã«ã¤ãªãŒã‚‹ãªã‚‰ã€‚"},
    {cat:"ä»•äº‹", title:"ã‚¹ãƒ¼ãƒ„ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ã‚µãƒœã‚‹ï¼Ÿ", amt:1200, payGood:0.62, riskPay:0.01, riskCut:0.14, impact:3, note:"è¦‹ãŸç›®ã¯ä¿¡ç”¨ã€‚"},
    {cat:"ä»•äº‹", title:"æ˜¼ãƒ¡ã‚·ã‚’æ¯å›å¤–é£Ÿã«ã™ã‚‹", amt:900, payGood:0.15, riskPay:0.02, riskCut:0.01, impact:1, note:"é »åº¦ãŒå…¨ã¦ã€‚"},
    {cat:"å®¶æ—", title:"æ—¥å¸°ã‚Šæ—…è¡Œã®è¨ˆç”»", amt:15000, payGood:0.58, riskPay:0.02, riskCut:0.14, impact:5, note:"æ€ã„å‡ºç³»ã€‚"},
    {cat:"å®¶æ—", title:"ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯ã«è¡Œã", amt:22000, payGood:0.55, riskPay:0.02, riskCut:0.16, impact:5, note:"æº€è¶³åº¦ã¯çˆ†ä¸ŠãŒã‚Šã€‚"},
    {cat:"å®¶æ—", title:"è¿‘å ´ã®å…¬åœ’ã§æ¸ˆã¾ã›ã‚‹ï¼ˆç¯€ç´„ï¼‰", amt:0, payGood:0.42, riskPay:0.00, riskCut:0.00, impact:4, note:"ãŠé‡‘ã‚’ä½¿ã‚ãªã„è‰¯æ‰‹ã€‚"},
    {cat:"å¥åº·", title:"ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã‚’è©¦ã—ã¦ã¿ã‚‹ï¼ˆä»Šæ—¥ã‚‚ï¼‰", amt:2921, payGood:0.28, riskPay:0.01, riskCut:0.02, impact:2, note:"ç¶šããªã‚‰æŠ•è³‡ã€‚"},
    {cat:"è¶£å‘³", title:"ã‚»ãƒ¼ãƒ«ã®åºƒå‘ŠãŒåˆºã•ã‚‹ï¼ˆã¾ãŸï¼‰", amt:4975, payGood:0.18, riskPay:0.02, riskCut:0.01, impact:2, note:"ã€å¿…è¦ã€ã‹ã€æ¬²ã—ã„ã€ã‹ã€‚"},
    {cat:"ä½ã¾ã„", title:"æ´—å‰¤ãƒ»æ—¥ç”¨å“ã‚’è²·ã„è¶³ã—ï¼ˆã¾ãŸï¼‰", amt:856, payGood:0.45, riskPay:0.01, riskCut:0.02, impact:2, note:"ã‚¹ãƒˆãƒƒã‚¯éå¤šæ³¨æ„ã€‚"},
    {cat:"æ•™è‚²", title:"å­ã©ã‚‚ã®å·¥ä½œã‚­ãƒƒãƒˆã‚’è²·ã†ï¼ˆã¾ãŸï¼‰", amt:2288, payGood:0.52, riskPay:0.01, riskCut:0.06, impact:3, note:"ä¸€ç·’ã«éŠã¹ã‚‹ã€‚"},
    {cat:"è»Š", title:"æ´—è»Šæ©Ÿã«å…¥ã‚Œã‚‹ã‹è¿·ã†ï¼ˆã¾ãŸï¼‰", amt:801, payGood:0.20, riskPay:0.01, riskCut:0.01, impact:1, note:"æ°—åˆ†è»¢æ›æ ã€‚"},
    {cat:"å¥åº·", title:"ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã‚’è©¦ã—ã¦ã¿ã‚‹ï¼ˆä»Šæ—¥ã‚‚ï¼‰", amt:4094, payGood:0.28, riskPay:0.01, riskCut:0.02, impact:2, note:"ç¶šããªã‚‰æŠ•è³‡ã€‚"},
    {cat:"äº¤éš›", title:"å¥¢ã‚Šãƒ»å¥¢ã‚‰ã‚Œå•é¡Œï¼ˆè¿·ã†ï¼‰", amt:2988, payGood:0.42, riskPay:0.02, riskCut:0.06, impact:3, note:"ç„¡ç†ã®ãªã„ç¯„å›²ã§ã€‚"},
    {cat:"äº¤éš›", title:"å¥¢ã‚Šãƒ»å¥¢ã‚‰ã‚Œå•é¡Œï¼ˆä»Šæ—¥ã‚‚ï¼‰", amt:2602, payGood:0.42, riskPay:0.02, riskCut:0.06, impact:3, note:"ç„¡ç†ã®ãªã„ç¯„å›²ã§ã€‚"},
    {cat:"è¶£å‘³", title:"ã‚»ãƒ¼ãƒ«ã®åºƒå‘ŠãŒåˆºã•ã‚‹ï¼ˆã¤ã„ï¼‰", amt:4698, payGood:0.18, riskPay:0.02, riskCut:0.01, impact:2, note:"ã€å¿…è¦ã€ã‹ã€æ¬²ã—ã„ã€ã‹ã€‚"},
    {cat:"é£Ÿè²»", title:"ãƒ¬ã‚¸å‰ã§ã¤ã„è¿½åŠ ï¼ˆã¾ãŸï¼‰", amt:417, payGood:0.08, riskPay:0.01, riskCut:0.01, impact:1, note:"å°ã•ã„å‡ºè²»ãŒç©ã‚€ã€‚"},
    {cat:"å‰¯æ¥­", title:"æ•™æã‚’è²·ã†ï¼ˆæœ¬/è¬›åº§ï¼‰ï¼ˆä»Šæ—¥ã‚‚ï¼‰", amt:10799, payGood:0.55, riskPay:0.02, riskCut:0.12, impact:3, note:"å®Ÿè·µã§ãã‚‹ãªã‚‰OKã€‚"},
    {cat:"äº¤éš›", title:"å¥¢ã‚Šãƒ»å¥¢ã‚‰ã‚Œå•é¡Œï¼ˆè¿·ã†ï¼‰", amt:3459, payGood:0.42, riskPay:0.02, riskCut:0.06, impact:3, note:"ç„¡ç†ã®ãªã„ç¯„å›²ã§ã€‚"},
    {cat:"è»Š", title:"æ´—è»Šæ©Ÿã«å…¥ã‚Œã‚‹ã‹è¿·ã†ï¼ˆã¾ãŸï¼‰", amt:668, payGood:0.20, riskPay:0.01, riskCut:0.01, impact:1, note:"æ°—åˆ†è»¢æ›æ ã€‚"},
    {cat:"è»Š", title:"æ´—è»Šæ©Ÿã«å…¥ã‚Œã‚‹ã‹è¿·ã†ï¼ˆã¾ãŸï¼‰", amt:501, payGood:0.20, riskPay:0.01, riskCut:0.01, impact:1, note:"æ°—åˆ†è»¢æ›æ ã€‚"},
    {cat:"è¶£å‘³", title:"ã‚»ãƒ¼ãƒ«ã®åºƒå‘ŠãŒåˆºã•ã‚‹ï¼ˆä»Šæ—¥ã‚‚ï¼‰", amt:4153, payGood:0.18, riskPay:0.02, riskCut:0.01, impact:2, note:"ã€å¿…è¦ã€ã‹ã€æ¬²ã—ã„ã€ã‹ã€‚"},
    {cat:"ä½ã¾ã„", title:"æ´—å‰¤ãƒ»æ—¥ç”¨å“ã‚’è²·ã„è¶³ã—ï¼ˆè¿·ã†ï¼‰", amt:872, payGood:0.45, riskPay:0.01, riskCut:0.02, impact:2, note:"ã‚¹ãƒˆãƒƒã‚¯éå¤šæ³¨æ„ã€‚"},
    {cat:"å‰¯æ¥­", title:"æ•™æã‚’è²·ã†ï¼ˆæœ¬/è¬›åº§ï¼‰ï¼ˆä»Šæ—¥ã‚‚ï¼‰", amt:8226, payGood:0.55, riskPay:0.02, riskCut:0.12, impact:3, note:"å®Ÿè·µã§ãã‚‹ãªã‚‰OKã€‚"},
    {cat:"é£Ÿè²»", title:"ãƒ¬ã‚¸å‰ã§ã¤ã„è¿½åŠ ï¼ˆä»Šæ—¥ã‚‚ï¼‰", amt:391, payGood:0.08, riskPay:0.01, riskCut:0.01, impact:1, note:"å°ã•ã„å‡ºè²»ãŒç©ã‚€ã€‚"},
    {cat:"è¶£å‘³", title:"ã‚»ãƒ¼ãƒ«ã®åºƒå‘ŠãŒåˆºã•ã‚‹ï¼ˆè¿·ã†ï¼‰", amt:5698, payGood:0.18, riskPay:0.02, riskCut:0.01, impact:2, note:"ã€å¿…è¦ã€ã‹ã€æ¬²ã—ã„ã€ã‹ã€‚"},
    {cat:"äº¤éš›", title:"å¥¢ã‚Šãƒ»å¥¢ã‚‰ã‚Œå•é¡Œï¼ˆã¾ãŸï¼‰", amt:3392, payGood:0.42, riskPay:0.02, riskCut:0.06, impact:3, note:"ç„¡ç†ã®ãªã„ç¯„å›²ã§ã€‚"},
    {cat:"è¶£å‘³", title:"ã‚»ãƒ¼ãƒ«ã®åºƒå‘ŠãŒåˆºã•ã‚‹ï¼ˆã¾ãŸï¼‰", amt:3874, payGood:0.18, riskPay:0.02, riskCut:0.01, impact:2, note:"ã€å¿…è¦ã€ã‹ã€æ¬²ã—ã„ã€ã‹ã€‚"},
    {cat:"é‡‘è", title:"ã‚¯ãƒ¬ã‚«æ˜ç´°ãƒã‚§ãƒƒã‚¯ã‚’å…ˆå»¶ã°ã—ï¼ˆã¤ã„ï¼‰", amt:0, payGood:0.70, riskPay:0.00, riskCut:0.25, impact:4, note:"ãƒã‚§ãƒƒã‚¯ã¯æœ€å¼·ã®ç¯€ç´„ã€‚"},
    {cat:"æ•™è‚²", title:"å­ã©ã‚‚ã®å·¥ä½œã‚­ãƒƒãƒˆã‚’è²·ã†ï¼ˆã¤ã„ï¼‰", amt:1552, payGood:0.52, riskPay:0.01, riskCut:0.06, impact:3, note:"ä¸€ç·’ã«éŠã¹ã‚‹ã€‚"},
    {cat:"ä½ã¾ã„", title:"æ´—å‰¤ãƒ»æ—¥ç”¨å“ã‚’è²·ã„è¶³ã—ï¼ˆã¾ãŸï¼‰", amt:1191, payGood:0.45, riskPay:0.01, riskCut:0.02, impact:2, note:"ã‚¹ãƒˆãƒƒã‚¯éå¤šæ³¨æ„ã€‚"},
    {cat:"é‡‘è", title:"ã‚¯ãƒ¬ã‚«æ˜ç´°ãƒã‚§ãƒƒã‚¯ã‚’å…ˆå»¶ã°ã—ï¼ˆè¿·ã†ï¼‰", amt:0, payGood:0.70, riskPay:0.00, riskCut:0.25, impact:4, note:"ãƒã‚§ãƒƒã‚¯ã¯æœ€å¼·ã®ç¯€ç´„ã€‚"},
    {cat:"å›ºå®šè²»", title:"ãƒã‚¤ãƒ³ãƒˆç›®å½“ã¦ã§ä¸è¦ãªè²·ã„ç‰©ï¼ˆæ°—ã¥ã„ãŸã‚‰ï¼‰", amt:2496, payGood:0.10, riskPay:0.02, riskCut:0.01, impact:1, note:"ãƒã‚¤ãƒ³ãƒˆã‚ˆã‚Šç¾é‡‘ã€‚"},
    {cat:"è¶£å‘³", title:"ã‚»ãƒ¼ãƒ«ã®åºƒå‘ŠãŒåˆºã•ã‚‹ï¼ˆã¤ã„ï¼‰", amt:2965, payGood:0.18, riskPay:0.02, riskCut:0.01, impact:2, note:"ã€å¿…è¦ã€ã‹ã€æ¬²ã—ã„ã€ã‹ã€‚"},
    {cat:"å›ºå®šè²»", title:"ãƒã‚¤ãƒ³ãƒˆç›®å½“ã¦ã§ä¸è¦ãªè²·ã„ç‰©ï¼ˆã¾ãŸï¼‰", amt:2446, payGood:0.10, riskPay:0.02, riskCut:0.01, impact:1, note:"ãƒã‚¤ãƒ³ãƒˆã‚ˆã‚Šç¾é‡‘ã€‚"},
    {cat:"å¥åº·", title:"ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã‚’è©¦ã—ã¦ã¿ã‚‹ï¼ˆæ°—ã¥ã„ãŸã‚‰ï¼‰", amt:4403, payGood:0.28, riskPay:0.01, riskCut:0.02, impact:2, note:"ç¶šããªã‚‰æŠ•è³‡ã€‚"},
    {cat:"æ•™è‚²", title:"å­ã©ã‚‚ã®å·¥ä½œã‚­ãƒƒãƒˆã‚’è²·ã†ï¼ˆæ°—ã¥ã„ãŸã‚‰ï¼‰", amt:1659, payGood:0.52, riskPay:0.01, riskCut:0.06, impact:3, note:"ä¸€ç·’ã«éŠã¹ã‚‹ã€‚"},

  ];

  // Difficulty parameters
  const DIFF = {
    easy:   {duration:60, spawnMin:900, spawnMax:1350, speedBonus:1.08, riskMul:0.85, scoreMul:0.92},
    normal: {duration:60, spawnMin:750, spawnMax:1150, speedBonus:1.14, riskMul:1.00, scoreMul:1.00},
    hard:   {duration:60, spawnMin:620, spawnMax:980,  speedBonus:1.22, riskMul:1.18, scoreMul:1.12},
  };

  // -------------------------
  // State
  // -------------------------
  const state = {
    running:false,
    duration:60,
    tLeft:60,
    startMoney:50000,
    balance:50000,
    score:0,
    best:0,
    seedStr:"",
    seed:0,
    rand:Math.random,
    nextAt:0,
    lastShownAt:0,
    current:null,
    decisions:0,
    payCount:0,
    cutCount:0,
    futureDamage:0, // counts
    totalAmt:0,
    mistakes:[], // {title, cat, deltaScore, reason}
    log:"-",
  };

  // Persisted settings
  const LS = {
    bestKey:"expenseJudge_best",
    settingsKey:"expenseJudge_settings",
  };

  function loadPersist(){
    try{
      const b = Number(localStorage.getItem(LS.bestKey) || "0");
      if(Number.isFinite(b)) state.best = b;
    }catch(e){}
    try{
      const s = JSON.parse(localStorage.getItem(LS.settingsKey) || "{}");
      if(s.startMoney) $('startMoney').value = String(s.startMoney);
      if(s.difficulty) $('difficulty').value = s.difficulty;
      if(typeof s.soundOn === "boolean") $('soundOn').checked = s.soundOn;
      if(typeof s.vibeOn === "boolean") $('vibeOn').checked = s.vibeOn;
    }catch(e){}
  }
  function savePersist(){
    try{ localStorage.setItem(LS.bestKey, String(state.best)); }catch(e){}
    try{
      localStorage.setItem(LS.settingsKey, JSON.stringify({
        startMoney: Number($('startMoney').value || 50000),
        difficulty: $('difficulty').value,
        soundOn: $('soundOn').checked,
        vibeOn: $('vibeOn').checked,
      }));
    }catch(e){}
  }

  function updateBestUI(){
    $('bestPill').textContent = `BEST: ${state.best ? fmt(state.best) : "-"}`;
  }

  // -------------------------
  // UI updates
  // -------------------------
  function setStateLabel(){
    $('statePill').textContent = state.running ? "ãƒ—ãƒ¬ã‚¤ä¸­" : "å¾…æ©Ÿä¸­";
  }
  function setButtons(enabled){
    $('btnPay').disabled = !enabled;
    $('btnCut').disabled = !enabled;
  }
  function setCard(card){
    state.current = card;
    $('catBadge').textContent = `# ${card.cat}`;
    $('amtText').textContent = `Â¥${fmt(card.amt)}`;
    $('qText').textContent = card.title;
    $('hintText').textContent = card.note;
    $('cardFace').classList.add('bump');
    setTimeout(()=> $('cardFace').classList.remove('bump'), 120);
  }
  function flash(ok){
    const el = $('cardFace');
    el.classList.remove('flash-good','flash-bad');
    void el.offsetWidth;
    el.classList.add(ok ? 'flash-good' : 'flash-bad');
    setTimeout(()=> el.classList.remove('flash-good','flash-bad'), 180);
  }
  function updateHUD(){
    $('timeLeft').textContent = String(state.tLeft);
    $('balance').textContent = fmt(state.balance);
    $('score').textContent = fmt(Math.max(0, Math.round(state.score)));

    const tPct = clamp(state.tLeft / state.duration, 0, 1) * 100;
    $('timeBar').querySelector('div').style.width = `${tPct}%`;

    const bPct = clamp(state.balance / state.startMoney, 0, 1) * 100;
    const balBar = $('balBar');
    balBar.querySelector('div').style.width = `${bPct}%`;
    balBar.classList.toggle('bad', bPct < 33);

    const sPct = clamp((Math.max(0, state.score)) / 4500, 0, 1) * 100;
    $('scoreBar').querySelector('div').style.width = `${sPct}%`;

    $('seedChip').textContent = `seed: ${state.seedStr}`;
    $('logLine').textContent = state.log;
  }

  // -------------------------
  // Game mechanics
  // -------------------------
  function pickCard(){
    const i = Math.floor(state.rand() * CARDS.length);
    // shallow copy
    return Object.assign({}, CARDS[i]);
  }

  function computeTruth(card){
    // Determine which is "better" based on payGood probability
    const payIsBetter = state.rand() < card.payGood;
    return payIsBetter; // true => pay is "correct"
  }

  function spawnCard(){
    const card = pickCard();
    card._shownAt = performance.now();
    card._payBetter = computeTruth(card);
    setCard(card);
    state.lastShownAt = card._shownAt;
  }

  function scheduleNext(){
    const d = DIFF[$('difficulty').value] || DIFF.normal;
    const ms = d.spawnMin + Math.floor(state.rand() * (d.spawnMax - d.spawnMin));
    state.nextAt = performance.now() + ms;
  }

  function addFutureDamage(reason){
    state.futureDamage += 1;
    state.log = `âš ï¸ å°†æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ç™ºç”Ÿï¼š${reason}`;
    beep(160, 0.08, 'sawtooth', 0.05);
    vibe(35);
  }

  function decide(choice){ // 'pay' or 'cut'
    if(!state.running || !state.current) return;

    const card = state.current;
    const d = DIFF[$('difficulty').value] || DIFF.normal;

    const reactionMs = performance.now() - card._shownAt;
    const speed = clamp(1 - (reactionMs / 1400), 0.05, 1); // 0..1
    const speedBonus = (0.6 + 0.8 * speed) * d.speedBonus; // ~0.6..1.4

    state.decisions += 1;
    state.totalAmt += card.amt;

    const payBetter = card._payBetter;
    const chosePay = choice === 'pay';
    const correct = (chosePay && payBetter) || (!chosePay && !payBetter);

    // Balance changes
    if(chosePay){
      state.balance -= card.amt;
      state.payCount += 1;
    }else{
      state.cutCount += 1;
    }

    // Future risk
    const r = state.rand();
    const riskChance = (chosePay ? card.riskPay : card.riskCut) * d.riskMul;
    if(r < riskChance){
      addFutureDamage(chosePay ? "æ‰•ã£ãŸã®ã«å¾Œæ‚”â€¦" : "å‰Šã‚Šã™ãã§åå‹•â€¦");
    }else{
      state.log = correct ? "âœ… ãƒŠã‚¤ã‚¹åˆ¤æ–­" : "ğŸŒ€ ãã®åˆ¤æ–­ã€ã¡ã‚‡ã„å±é™º";
    }

    // Scoring:
    // - Correct => + base points (amount-weighted) * speedBonus
    // - Wrong => - penalty (amount-weighted) and record mistake
    // - Extra: cutting high impact items reduces score slightly (satisfaction hit)
    const amtFactor = clamp(card.amt / 10000, 0.1, 3.0); // weight
    const base = (120 + 110 * amtFactor) * d.scoreMul;

    let delta = 0;
    if(correct){
      delta += base * speedBonus;
      beep(880, 0.06, 'triangle', 0.05);
      vibe(12);
      flash(true);
    }else{
      const penalty = (base * (1.1 + 0.4 * (1-speed))) * 0.9;
      delta -= penalty;
      beep(220, 0.08, 'square', 0.05);
      vibe(28);
      flash(false);

      // record mistake
      const reason = chosePay
        ? "æ‰•ã‚ãªãã¦ã‚ˆã‹ã£ãŸå‡ºè²»ã‚’æ‰•ã£ãŸ"
        : "å‰Šã‚‹ã¨å¾Œã§åŠ¹ãå‡ºè²»ã‚’å‰Šã£ãŸ";
      state.mistakes.push({
        title: card.title,
        cat: card.cat,
        deltaScore: -penalty,
        reason
      });
    }

    // Satisfaction penalty when cutting high impact (even if correct)
    if(!chosePay && card.impact >= 4){
      const sat = 55 + 35 * card.impact; // 195..230
      delta -= sat * d.scoreMul;
      state.mistakes.push({
        title: card.title,
        cat: card.cat,
        deltaScore: -sat * d.scoreMul,
        reason: "å‰Šã‚Šã™ãï¼ˆæº€è¶³åº¦ãƒ€ã‚¦ãƒ³ï¼‰"
      });
    }

    // If balance below 0 => game over early
    state.score += delta;
    updateHUD();

    if(state.balance <= 0){
      state.balance = 0;
      updateHUD();
      endGame(true);
      return;
    }

    // Next card
    spawnCard();
    scheduleNext();
  }

  function startGame(){
    // parse start money
    const m = Number(String($('startMoney').value || "").replace(/[^\d]/g,"")) || 50000;
    const dkey = $('difficulty').value;

    savePersist();

    const d = DIFF[dkey] || DIFF.normal;
    state.duration = d.duration;
    state.tLeft = d.duration;

    state.startMoney = clamp(m, 5000, 5000000);
    state.balance = state.startMoney;
    state.score = 0;
    state.decisions = 0;
    state.payCount = 0;
    state.cutCount = 0;
    state.futureDamage = 0;
    state.totalAmt = 0;
    state.mistakes = [];
    state.log = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼";

    // Seed: based on day+time & user settings
    const seedStr = `${Date.now()}-${state.startMoney}-${dkey}`;
    state.seedStr = String(hashSeed(seedStr)).slice(0,8);
    state.seed = hashSeed(seedStr);
    state.rand = mulberry32(state.seed);

    state.running = true;
    setStateLabel();
    setButtons(true);

    spawnCard();
    scheduleNext();
    updateHUD();

    $('btnStart').textContent = "â¸ åœæ­¢";
    $('btnStart').classList.remove('btn-main');
    $('btnStart').classList.add('btn-ghost');

    beep(660, 0.08, 'sine', 0.05);
    vibe(18);
  }

  function stopGame(){
    state.running = false;
    setStateLabel();
    setButtons(false);
    $('btnStart').textContent = "â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ";
    $('btnStart').classList.add('btn-main');
    $('btnStart').classList.remove('btn-ghost');
    state.log = "åœæ­¢ã—ã¾ã—ãŸ";
    updateHUD();
  }

  function resetGame(){
    stopGame();
    state.tLeft = 60;
    state.balance = Number(String($('startMoney').value || "50000").replace(/[^\d]/g,"")) || 50000;
    state.score = 0;
    state.current = null;
    state.log = "-";
    $('catBadge').textContent = "ã‚«ãƒ†ã‚´ãƒªãƒ¼";
    $('amtText').textContent = "Â¥0";
    $('qText').textContent = "ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ã­";
    $('hintText').textContent = "å‡ºè²»ã‚«ãƒ¼ãƒ‰ãŒå‡ºãŸã‚‰ã€Œæ‰•ã† / å‰Šã‚‹ã€ã§åˆ¤æ–­ã€‚å‰Šã‚‹ã¨å°†æ¥ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒã‚ã‚‹ã“ã¨ã‚‚ã€‚";
    updateHUD();
  }

  function endGame(bankrupt=false){
    state.running = false;
    setButtons(false);
    setStateLabel();

    const finalScore = Math.max(0, Math.round(state.score));
    if(finalScore > state.best){
      state.best = finalScore;
      updateBestUI();
      savePersist();
    }

    $('finalScore').textContent = fmt(finalScore);
    $('finalBal').textContent = `Â¥${fmt(state.balance)}`;
    $('finalRisk').textContent = String(state.futureDamage);

    const avgAmt = state.decisions ? Math.round(state.totalAmt / state.decisions) : 0;
    const payRate = state.decisions ? Math.round((state.payCount/state.decisions)*100) : 0;

    // Comment generation
    let comment = "";
    if(bankrupt){
      comment = "ğŸ’¥ ç ´ç”£ï¼åˆ¤æ–­ã¯é€Ÿã„ã‘ã©ã€è‡´å‘½å‚·ã®å‡ºè²»ãŒå¤šã‹ã£ãŸã‹ã‚‚ã€‚å›ºå®šè²»ã‹ã‚‰æ½°ã—ã¦ã„ã“ã†ã€‚";
    }else if(state.futureDamage >= 4){
      comment = "âš ï¸ å°†æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸å¤šã‚ã€‚å‰Šã‚Šã™ãï¼å…ˆå»¶ã°ã—ãŒåˆºã•ã£ã¦ã‚‹ã€‚å®‰å…¨ãƒ»å¥åº·ã¯å®ˆã‚Šã¤ã¤å›ºå®šè²»ã‚’å‰Šã‚ã†ã€‚";
    }else if(finalScore >= 3200){
      comment = "ğŸ† å®¶è¨ˆé˜²è¡›ã®ãƒ—ãƒ­ã€‚åˆ¤æ–­ãŒé€Ÿãã¦ç²¾åº¦ã‚‚é«˜ã„ã€‚ã‚ã¨ã¯å›ºå®šè²»æœ€é©åŒ–ã§ç„¡åŒã§ãã‚‹ã€‚";
    }else if(finalScore >= 1800){
      comment = "âœ… æ‚ªããªã„ã€‚ãƒãƒªãƒ„ãƒ¢ã‚’æŠ‘ãˆã‚‹ã¨ä¸€æ°—ã«ä¼¸ã³ã‚‹ã€‚ã‚µãƒ–ã‚¹ã‚¯ãƒ»é€šä¿¡ãƒ»ä¿é™ºã®è¦‹ç›´ã—ãŒéµã€‚";
    }else{
      comment = "ğŸŒ€ ä¼¸ã³ã—ã‚ã‚ã‚Šã€‚è¿·ã„ãŒã‚¹ã‚³ã‚¢ã‚’æº¶ã‹ã™ã€‚ã€å¤§ãã„å›ºå®šè²»ã¯å‰Šã‚‹ã€ã€å®‰å…¨ã¯å®ˆã‚‹ã€ã ã‘è¦šãˆã‚Œã°å‹ã¦ã‚‹ã€‚";
    }
    $('finalComment').textContent = comment;

    // Top mistakes
    const mm = state.mistakes.slice()
      .sort((a,b)=> (a.deltaScore - b.deltaScore)) // more negative first
      .slice(0,3);

    const top = $('topMistakes');
    top.innerHTML = "";
    if(mm.length === 0){
      const li = document.createElement('li');
      li.textContent = "ç›®ç«‹ã£ãŸãƒŸã‚¹ãªã—ã€‚åˆ¤æ–­ãŒå®‰å®šã—ã¦ã‚‹ï¼";
      top.appendChild(li);
    }else{
      for(const m of mm){
        const li = document.createElement('li');
        li.textContent = `ã€${m.cat}ã€‘${m.title}ï¼ˆ${m.reason}ï¼‰`;
        top.appendChild(li);
      }
    }

    // Tendencies
    const t = $('tendency');
    t.innerHTML = "";
    const addT = (s) => { const li=document.createElement('li'); li.textContent=s; t.appendChild(li); };

    addT(`æ‰•ã†ç‡ï¼š${payRate}% / å‰Šã‚‹ç‡ï¼š${100-payRate}%`);
    addT(`1å›ã‚ãŸã‚Šå¹³å‡å‡ºè²»ï¼šÂ¥${fmt(avgAmt)}`);
    addT(`å°†æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼š${state.futureDamage} å›`);
    if(payRate >= 70) addT("å‚¾å‘ï¼šå®‰å¿ƒé‡è¦–ï¼ˆæ‰•ã†å¤šã‚ï¼‰â†’ å›ºå®šè²»ã‚’å®šæœŸç‚¹æ¤œã™ã‚‹ã¨å¼·ã„");
    else if(payRate <= 40) addT("å‚¾å‘ï¼šç¯€ç´„é‡è¦–ï¼ˆå‰Šã‚‹å¤šã‚ï¼‰â†’ å¥åº·ãƒ»å®‰å…¨ã¯å®ˆã£ã¦å‹ã¤");
    else addT("å‚¾å‘ï¼šãƒãƒ©ãƒ³ã‚¹å‹ â†’ è¿·ã£ãŸã‚‰ã€å›ºå®šè²»ã¯å‰Šã‚‹ã€ã§OK");

    // Show result modal
    $('modalResult').classList.add('show');

    // Reset start button text
    $('btnStart').textContent = "â–¶ï¸ ã‚¹ã‚¿ãƒ¼ãƒˆ";
    $('btnStart').classList.add('btn-main');
    $('btnStart').classList.remove('btn-ghost');

    beep(520, 0.12, 'triangle', 0.05);
    vibe(22);
  }

  // Timer loop (1 sec tick)
  let tickTimer = null;
  function startTimerLoop(){
    if(tickTimer) clearInterval(tickTimer);
    tickTimer = setInterval(() => {
      if(!state.running) return;
      state.tLeft -= 1;
      if(state.tLeft <= 0){
        state.tLeft = 0;
        updateHUD();
        endGame(false);
        return;
      }
      updateHUD();
    }, 1000);
  }

  // card spawn loop (based on nextAt)
  function spawnLoop(){
    const loop = () => {
      if(state.running && state.current){
        const t = performance.now();
        // è‡ªå‹•ã§ã‚«ãƒ¼ãƒ‰ã‚’é€²ã‚ãªã„ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å…¥åŠ›ã§é€²è¡Œï¼‰
        
}
      requestAnimationFrame(loop);
    };
    requestAnimationFrame(loop);
  }

  // Clipboard / share text
  function resultText(){
    const s = Math.max(0, Math.round(state.score));
    const d = $('difficulty').value;
    const txt =
`å‡ºè²»ã‚¸ãƒ£ãƒƒã‚¸ã‚²ãƒ¼ãƒ ï½œçµæœ
ã‚¹ã‚³ã‚¢ï¼š${s} pt
æ®‹é«˜ï¼šÂ¥${fmt(state.balance)}
å°†æ¥ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼š${state.futureDamage}
é›£æ˜“åº¦ï¼š${d}
#å‡ºè²»ã‚¸ãƒ£ãƒƒã‚¸ #å®¶è¨ˆã‚²ãƒ¼ãƒ `;
    return txt;
  }
  async function copyResult(){
    const txt = resultText();
    try{
      await navigator.clipboard.writeText(txt);
      toast("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆä»£æ›¿ï¼‰");
    }
    beep(740, 0.06, 'sine', 0.05);
    vibe(12);
  }

  // -------------------------
  // Events
  // -------------------------
  $('btnStart').addEventListener('click', () => {
    if(state.running) stopGame();
    else startGame();
  });
  $('btnReset').addEventListener('click', resetGame);

  $('btnPay').addEventListener('click', () => decide('pay'));
  $('btnCut').addEventListener('click', () => decide('cut'));

  // Keyboard
  window.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowLeft'){ decide('pay'); }
    else if(e.key === 'ArrowRight'){ decide('cut'); }
    else if(e.code === 'Space'){
      e.preventDefault();
      if(state.running) stopGame();
      else startGame();
    }
  }, {passive:false});

  // Modals
  const openHow = () => $('modalHow').classList.add('show');
  const closeHow = () => $('modalHow').classList.remove('show');
  $('btnHow').addEventListener('click', openHow);
  $('btnCloseHow').addEventListener('click', closeHow);
  $('modalHow').addEventListener('click', (e)=>{ if(e.target.id==='modalHow') closeHow(); });

  const closeResult = () => $('modalResult').classList.remove('show');
  $('btnCloseResult').addEventListener('click', closeResult);
  $('modalResult').addEventListener('click', (e)=>{ if(e.target.id==='modalResult') closeResult(); });

  $('btnAgain').addEventListener('click', () => {
    $('modalResult').classList.remove('show');
    startGame();
  });

  $('btnShare').addEventListener('click', copyResult);
  $('btnCopy2').addEventListener('click', copyResult);

  // Save settings on change
  $('startMoney').addEventListener('change', savePersist);
  $('difficulty').addEventListener('change', savePersist);
  $('soundOn').addEventListener('change', savePersist);
  $('vibeOn').addEventListener('change', savePersist);

  // Init
  loadPersist();
  updateBestUI();
  startTimerLoop();
  spawnLoop();
  resetGame();

})();
</script>

<script>
  // PWA: Service Worker
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    });
  }
</script>
</body>
</html>
